From 8dee9ecddb83e174e6878cf4ec5a35f0d02701a7 Mon Sep 17 00:00:00 2001
From: Juan Cruz Linsalata <LinsaFTW@users.noreply.github.com>
Date: Sun, 18 Oct 2020 16:24:25 -0300
Subject: [PATCH] Made proxyping cancellable


diff --git a/api/src/main/java/net/md_5/bungee/api/event/ProxyPingEvent.java b/api/src/main/java/net/md_5/bungee/api/event/ProxyPingEvent.java
index 4baa06a9..05bccaca 100644
--- a/api/src/main/java/net/md_5/bungee/api/event/ProxyPingEvent.java
+++ b/api/src/main/java/net/md_5/bungee/api/event/ProxyPingEvent.java
@@ -2,10 +2,13 @@ package net.md_5.bungee.api.event;
 
 import lombok.Data;
 import lombok.EqualsAndHashCode;
+import lombok.Getter;
+import lombok.Setter;
 import lombok.ToString;
 import net.md_5.bungee.api.Callback;
 import net.md_5.bungee.api.ServerPing;
 import net.md_5.bungee.api.connection.PendingConnection;
+import net.md_5.bungee.api.plugin.Cancellable;
 
 /**
  * Called when the proxy is pinged with packet 0xFE from the server list.
@@ -13,9 +16,12 @@ import net.md_5.bungee.api.connection.PendingConnection;
 @Data
 @ToString(callSuper = false)
 @EqualsAndHashCode(callSuper = false)
-public class ProxyPingEvent extends AsyncEvent<ProxyPingEvent>
+// FlameCord - Make ProxyPingEvent cancellable
+public class ProxyPingEvent extends AsyncEvent<ProxyPingEvent> implements Cancellable
 {
-
+    @Getter
+    @Setter
+    private boolean cancelled = false;
     /**
      * The connection asking for a ping response.
      */
diff --git a/proxy/src/main/java/net/md_5/bungee/connection/InitialHandler.java b/proxy/src/main/java/net/md_5/bungee/connection/InitialHandler.java
index 138dffa0..dfc5ed93 100644
--- a/proxy/src/main/java/net/md_5/bungee/connection/InitialHandler.java
+++ b/proxy/src/main/java/net/md_5/bungee/connection/InitialHandler.java
@@ -278,21 +278,21 @@ public class InitialHandler extends PacketHandler implements PendingConnection
                     @Override
                     public void done(ProxyPingEvent pingResult, Throwable error)
                     {
-                        Gson gson = handshake.getProtocolVersion() == ProtocolConstants.MINECRAFT_1_7_2 ? BungeeCord.getInstance().gsonLegacy : BungeeCord.getInstance().gson; // Travertine
-                        if ( bungee.getConnectionThrottle() != null )
-                        {
-                            bungee.getConnectionThrottle().unthrottle( getSocketAddress() );
-                        }
-
-                        // FlameCord - Close if response is null
+                        // FlameCord - Return and close if response is null or cancelled
                         // FlameCord - Return if connection is closed
-                        if (pingResult.getResponse() == null) {
+                        if (pingResult.getResponse() == null || pingResult.isCancelled()) {
                             ch.close();
                             return;
                         } else if (ch.isClosed()) {
                             return;
                         }
 
+                        Gson gson = handshake.getProtocolVersion() == ProtocolConstants.MINECRAFT_1_7_2 ? BungeeCord.getInstance().gsonLegacy : BungeeCord.getInstance().gson; // Travertine
+                        if ( bungee.getConnectionThrottle() != null )
+                        {
+                            bungee.getConnectionThrottle().unthrottle( getSocketAddress() );
+                        }
+
                         // Travertine start
                         if ( ProtocolConstants.isBeforeOrEq( handshake.getProtocolVersion() , ProtocolConstants.MINECRAFT_1_8 ) )
                         {
-- 
2.27.0.windows.1

